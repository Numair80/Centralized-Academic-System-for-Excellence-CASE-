// Notes Repository Database Schema
generator client {
  provider = "prisma-client-js"
  output   = "../generated/notes-client"
}

datasource db {
  provider = "postgresql"
  url      = env("NOTES_DATABASE_URL")
}

model Note {
  id               Int      @id @default(autoincrement())
  title            String   @db.VarChar(255)
  subject          String?  @db.VarChar(100)
  branch           String?  @db.VarChar(100)
  semester         String?  @db.VarChar(10)
  description      String?  @db.Text
  file_url         String   @db.Text
  file_type        String?  @db.VarChar(50)
  file_size        BigInt?
  uploaded_by      String?  @db.VarChar(100)
  uploader_id      String?  @db.VarChar(50)
  user_type        String?  @db.VarChar(50) // Student, Faculty, Admin
  faculty_verified Boolean  @default(false)
  verified_by      String?  @db.VarChar(100)
  verified_at      DateTime?
  tags             String[] @default([])
  downloads        Int      @default(0)
  upvotes          Int      @default(0)
  downvotes        Int      @default(0)
  is_active        Boolean  @default(true)
  upload_date      DateTime @default(now())
  updated_at       DateTime @updatedAt

  firebase_path     String?   @db.VarChar(500)
  original_filename String?   @db.VarChar(255)
  uploader_name     String?   @db.VarChar(100)


  bookmarks     NoteBookmark[]
  votes         NoteVote[]
  reports       NoteReport[]
  downloadLogs  NoteDownload[]

  @@map("notes")
}

model NoteDownload {
  id           Int      @id @default(autoincrement())
  note_id      Int
  user_id      String   @db.VarChar(50)
  user_name    String?  @db.VarChar(100)
  user_type    String   @db.VarChar(20) // Student, Faculty, Admin
  user_email   String?  @db.VarChar(100)
  department   String?  @db.VarChar(100)
  branch       String?  @db.VarChar(100)
  semester     String?  @db.VarChar(10)
  ip_address   String?  @db.VarChar(45) // IPv4 or IPv6
  user_agent   String?  @db.Text
  download_at  DateTime @default(now())
  file_name    String?  @db.VarChar(255)
  file_size    BigInt?
  download_status String @default("Success") @db.VarChar(20) // Success, Failed, Cancelled

  note Note @relation(fields: [note_id], references: [id], onDelete: Cascade)

  @@index([note_id])
  @@index([user_id])
  @@index([download_at])
  @@index([user_type])
  @@map("note_downloads")
}

model NoteBookmark {
  id         Int      @id @default(autoincrement())
  note_id    Int
  user_id    String   @db.VarChar(50)
  user_type  String   @db.VarChar(20) // Student, Faculty, Admin
  created_at DateTime @default(now())

  note Note @relation(fields: [note_id], references: [id], onDelete: Cascade)

  @@unique([note_id, user_id])
  @@map("note_bookmarks")
}

model NoteVote {
  id         Int      @id @default(autoincrement())
  note_id    Int
  user_id    String   @db.VarChar(50)
  vote_type  String   @db.VarChar(10) // upvote, downvote
  created_at DateTime @default(now())

  note Note @relation(fields: [note_id], references: [id], onDelete: Cascade)

  @@unique([note_id, user_id])
  @@map("note_votes")
}

model NoteReport {
  id          Int      @id @default(autoincrement())
  note_id     Int
  reported_by String   @db.VarChar(50)
  reason      String   @db.VarChar(100)
  description String?  @db.Text
  status      String   @default("Pending") @db.VarChar(20) // Pending, Reviewed, Resolved
  created_at  DateTime @default(now())

  note Note @relation(fields: [note_id], references: [id], onDelete: Cascade)

  @@map("note_reports")
}

model NoteCategory {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  color       String?  @db.VarChar(7) // Hex color code
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())

  @@map("note_categories")
}

model NoteRequest {
  id          Int      @id @default(autoincrement())
  title       String   @db.VarChar(255)
  subject     String   @db.VarChar(100)
  branch      String   @db.VarChar(100)
  semester    String   @db.VarChar(10)
  description String?  @db.Text
  requested_by String  @db.VarChar(50)
  user_type   String   @db.VarChar(20)
  priority    String   @default("Normal") @db.VarChar(20) // Low, Normal, High
  status      String   @default("Open") @db.VarChar(20) // Open, Fulfilled, Closed
  fulfilled_by String? @db.VarChar(50)
  fulfilled_at DateTime?
  created_at  DateTime @default(now())

  @@map("note_requests")
}
